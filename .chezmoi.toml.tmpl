# Machine classification axes (all orthogonal):
#
#   OS            — automatic via .chezmoi.os (darwin / linux)
#   is_headless   — GUI (false) vs terminal-only (true)
#   trust_level   — what secrets to place on this machine:
#                     personal = everything (personal keys, API tokens, .secrets.env)
#                     work     = work credentials only, no personal secrets
#                     server   = no secrets in dotfiles at all
#
# Re-prompt all values: `chezmoi init --prompt`

{{ $email := promptStringOnce . "email" "Email address" "flo@kempenich.dev" -}}
{{ $trust_level := promptChoiceOnce . "trust_level" "Trust level (personal = all secrets, work = work only, server = none)" (list "personal" "work" "server") -}}
{{ $is_headless := promptBoolOnce . "is_headless" "Is this a headless machine (no GUI)" false -}}


[data]
    email = {{ $email | quote }}
    trust_level = {{ $trust_level | quote }}
    is_headless = {{ $is_headless }}


[add]
    # Prevent accidentally committing plaintext secrets to the source repo.
    secrets = "error"


[git]
    autoCommit = false


[diff]
    command = "delta"


[[textconv]]
    # Render binary plists as readable XML in diffs.
    pattern = "**/*.plist"
    command = "plutil"
    args = ["-convert", "xml1", "-o", "-", "-"]


[merge]
    # Use VS Code as a 3-way merge editor for conflicts.
    command = "bash"
    args = [
        "-c",
        "cp {{ "{{ .Target }} {{ .Target }}.base && code --new-window --wait --merge {{ .Destination }} {{ .Target }} {{ .Target }}.base {{ .Source }}" }}",
    ]


[hooks.read-source-state.pre]
    # Runs before chezmoi reads the source state (i.e. on every chezmoi command).
    # Installs the password manager (rbw) if it's not already on PATH.
    command = ".local/share/chezmoi/.ensure-password-manager-installed.sh"
